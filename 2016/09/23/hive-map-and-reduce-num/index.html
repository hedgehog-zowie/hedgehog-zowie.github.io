<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>hive的查询注意事项以及优化总结 | 破而后立</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">hive的查询注意事项以及优化总结</h1><a id="logo" href="/.">破而后立</a><p class="description">凡事破必有一立</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">hive的查询注意事项以及优化总结</h1><div class="post-meta">Sep 23, 2016<span> | </span><span class="category"><a href="/categories/hive/">hive</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/09/23/hive-map-and-reduce-num/" href="/2016/09/23/hive-map-and-reduce-num/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、控制Hive中Map和reduce的数量"><span class="toc-number">1.</span> <span class="toc-text">一、控制Hive中Map和reduce的数量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、-map的数量"><span class="toc-number">1.1.</span> <span class="toc-text">1、 map的数量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、-reduce数量"><span class="toc-number">1.2.</span> <span class="toc-text">2、 reduce数量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、join和Group的优化"><span class="toc-number">2.</span> <span class="toc-text">二、join和Group的优化</span></a></li></ol></div></div><div class="post-content"><p>原文地址：<a href="http://www.cnblogs.com/xd502djj/p/3799432.html" target="_blank" rel="external">http://www.cnblogs.com/xd502djj/p/3799432.html</a></p>
<h1 id="一、控制Hive中Map和reduce的数量"><a href="#一、控制Hive中Map和reduce的数量" class="headerlink" title="一、控制Hive中Map和reduce的数量"></a>一、控制Hive中Map和reduce的数量</h1><p>Hive中的sql查询会生成执行计划，执行计划以MapReduce的方式执行，那么结合数据和集群的大小，map和reduce的数量就会影响到sql执行的效率。<br>除了要控制Hive生成的Job的数量，也要控制map和reduce的数量。</p>
<h2 id="1、-map的数量"><a href="#1、-map的数量" class="headerlink" title="1、 map的数量"></a>1、 map的数量</h2><p>map的数量，通常情况下和split的大小有关系，之前写的一篇blog“map和reduce的数量是如何定义的”有描述。<br>hive中默认的hive.input.format是org.apache.Hadoop.hive.ql.io.CombineHiveInputFormat，对于combineHiveInputFormat,它的输入的map数量<br>由三个配置决定，<br>mapred.min.split.size.per.node， 一个节点上split的至少的大小<br>mapred.min.split.size.per.rack 一个交换机下split至少的大小<br>mapred.max.split.size 一个split最大的大小<br>它的主要思路是把输入目录下的大文件分成多个map的输入, 并合并小文件, 做为一个map的输入. 具体的原理是下述三步:<br>a、根据输入目录下的每个文件,如果其长度超过mapred.max.split.size,以block为单位分成多个split(一个split是一个map的输入),每个split的长度都大于mapred.max.split.size, 因为以block为单位, 因此也会大于blockSize, 此文件剩下的长度如果大于mapred.min.split.size.per.node, 则生成一个split, 否则先暂时保留.<br>b、现在剩下的都是一些长度效短的碎片,把每个rack下碎片合并, 只要长度超过mapred.max.split.size就合并成一个split, 最后如果剩下的碎片比mapred.min.split.size.per.rack大, 就合并成一个split, 否则暂时保留.<br>c、把不同rack下的碎片合并, 只要长度超过mapred.max.split.size就合并成一个split, 剩下的碎片无论长度, 合并成一个split.<br>举例:<br>mapred.max.split.size=1000<br>mapred.min.split.size.per.node=300<br>mapred.min.split.size.per.rack=100<br>输入目录下五个文件,rack1下三个文件,长度为2050,1499,10, rack2下两个文件,长度为1010,80. 另外blockSize为500.<br>经过第一步, 生成五个split: 1000,1000,1000,499,1000. 剩下的碎片为rack1下:50,10; rack2下10:80<br>由于两个rack下的碎片和都不超过100, 所以经过第二步, split和碎片都没有变化.<br>第三步,合并四个碎片成一个split, 长度为150.<br>如果要减少map数量, 可以调大mapred.max.split.size, 否则调小即可.<br>其特点是: 一个块至多作为一个map的输入，一个文件可能有多个块，一个文件可能因为块多分给做为不同map的输入， 一个map可能处理多个块，可能处理多个文件。</p>
<h2 id="2、-reduce数量"><a href="#2、-reduce数量" class="headerlink" title="2、 reduce数量"></a>2、 reduce数量</h2><p>可以在hive运行sql的时，打印出来，如下：<br>Number of reduce tasks not specified. Estimated from input data size: 1<br>In order to change the average load for a reducer (in bytes):<br>  set hive.exec.reducers.bytes.per.reducer=<number><br>In order to limit the maximum number of reducers:<br>  set hive.exec.reducers.max=<number><br>In order to set a constant number of reducers:<br>  set mapred.reduce.tasks=<number></number></number></number></p>
<p>reduce数量由以下三个参数决定，<br>mapred.reduce.tasks(强制指定reduce的任务数量)<br>hive.exec.reducers.bytes.per.reducer（每个reduce任务处理的数据量，默认为1000^3=1G）<br>hive.exec.reducers.max（每个任务最大的reduce数，默认为999）<br>计算reducer数的公式很简单N=min( hive.exec.reducers.max ，总输入数据量/ hive.exec.reducers.bytes.per.reducer )<br>  只有一个reduce的场景：<br>  a、没有group by 的汇总<br>  b、order by<br>  c、笛卡尔积</p>
<h1 id="二、join和Group的优化"><a href="#二、join和Group的优化" class="headerlink" title="二、join和Group的优化"></a>二、join和Group的优化</h1><p>对于普通的join操作，会在map端根据key的hash值，shuffle到某一个reduce上去，在reduce端做join连接操作，内存中缓存join左边的表，遍历右边的表，一次做join操作。所以在做join操作时候，将数据量多的表放在join的右边。<br>当数据量比较大，并且key分布不均匀，大量的key都shuffle到一个reduce上了，就出现了数据的倾斜。</p>
<p>对于Group操作，首先在map端聚合，最后在reduce端坐聚合，hive默认是这样的，以下是相关的参数<br>· hive.map.aggr = true是否在 Map 端进行聚合，默认为 True<br>· hive.groupby.mapaggr.checkinterval = 100000在 Map 端进行聚合操作的条目数目</p>
<p>对于join和Group操作都可能会出现数据倾斜。<br>以下有几种解决这个问题的常见思路<br>1、参数hive.groupby.skewindata = true,解决数据倾斜的万能钥匙，查询计划会有两个 MR Job。第一个 MR Job 中，Map 的输出结果集合会随机分布到 Reduce 中，每个 Reduce 做部分聚合操作，并输出结果，这样处理的结果是相同的 Group By Key 有可能被分发到不同的 Reduce 中，从而达到负载均衡的目的；第二个 MR Job 再根据预处理的数据结果按照 Group By Key 分布到 Reduce 中（这个过程可以保证相同的 Group By Key 被分布到同一个 Reduce 中），最后完成最终的聚合操作。<br>2、where的条件写在join里面，使得减少join的数量（经过map端过滤，只输出复合条件的）<br>3、mapjoin方式，无reduce操作，在map端做join操作（map端cache小表的全部数据），这种方式下无法执行Full/RIGHT OUTER join操作<br>4、对于count(distinct)操作，在map端以group by的字段和count的字段联合作为key，如果有大量相同的key，那么会存在数据倾斜的问题<br>5、数据的倾斜还包括，大量的join连接key为空的情况，空的key都hash到一个reduce上去了，解决这个问题，最好把空的key和非空的key做区分<br>空的key不做join操作。<br>当然有的hive操作，不存在数据倾斜的问题，比如数据聚合类的操作，像sum、count，因为已经在map端做了聚合操作了，到reduce端的数据相对少一些，所以不存在这个问题。</p>
<p>四、小文件的合并<br>大量的小文件导致文件数目过多，给HDFS带来压力，对hive处理的效率影响比较大，可以合并map和reduce产生的文件<br>· hive.merge.mapfiles = true是否和并 Map 输出文件，默认为 True<br>· hive.merge.mapredfiles = false是否合并 Reduce 输出文件，默认为 False<br>· hive.merge.size.per.task = 256<em>1000</em>1000合并文件的大小</p>
<p>五、in/exists（not）<br>通过left semi join 实现 in操作，一个限制就是join右边的表只能出现在join条件中</p>
<p>六、分区裁剪<br>通过在条件中指定分区，来限制数据扫描的范围，可以极大提高查询的效率</p>
<p>七、排序<br>order by 排序，只存在一个reduce，这样效率比较低。<br>可以用sort by操作,通常结合distribute by使用做reduce分区键</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://jackalope.cn/2016/09/23/hive-map-and-reduce-num/" data-id="ciz96ob4e00040sek14z4ap2g" class="article-share-link">分享到</a><div class="tags"><a href="/tags/hive/">hive</a></div><div class="post-nav"><a href="/2016/09/23/js-dataTables-mergeCells/" class="pre">dataTables合并单元格的实现方法</a><a href="/2016/09/23/mysql-tips/" class="next">mysql-tips</a></div><div id="disqus_thread"><script>var disqus_shortname = 'hedgehog-zowie';
var disqus_identifier = '2016/09/23/hive-map-and-reduce-num/';
var disqus_title = 'hive的查询注意事项以及优化总结';
var disqus_url = 'http://jackalope.cn/2016/09/23/hive-map-and-reduce-num/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//hedgehog-zowie.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://jackalope.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Flume/">Flume</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java总结/">Java总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hbase/">hbase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hive/">hive</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spasrk/">spasrk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/sqoop/">sqoop</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/jni/" style="font-size: 15px;">jni</a> <a href="/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/hive/" style="font-size: 15px;">hive</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/nio/" style="font-size: 15px;">nio</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/Flume/" style="font-size: 15px;">Flume</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/als-spark-ml/" style="font-size: 15px;">als spark ml</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/sqoop/" style="font-size: 15px;">sqoop</a> <a href="/tags/spring-spring-data-hadoop/" style="font-size: 15px;">spring spring-data hadoop</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/js-dataTables/" style="font-size: 15px;">js dataTables</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/flume-trouble-shooting/">flume-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/spring-trouble-shooting/">sqoop-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/sqoop-trouble-shooting/">sqoop-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/shell-trouble-shooting/">shell-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/spark-trouble-shooting/">spark-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/hive-trouble-shooting/">hive-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/hbase-trouble-shooting/">hbase-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/23/hbase-tips/">hbase-tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/23/spark-tips/">spark-tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/23/spark-ml-als/">ALS矩阵分解算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//hedgehog-zowie.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">破而后立.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>