<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>JNI（Java Native Interface）原理与使用 | 破而后立</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JNI（Java Native Interface）原理与使用</h1><a id="logo" href="/.">破而后立</a><p class="description">凡事破必有一立</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a><a href="/guestbook/"><i class="fa fa-comments"> 留言</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JNI（Java Native Interface）原理与使用</h1><div class="post-meta">Apr 13, 2016<span> | </span><span class="category"><a href="/categories/java基础/">java基础</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/04/13/java-core-jni/" href="/2016/04/13/java-core-jni/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#知识图"><span class="toc-number">2.</span> <span class="toc-text">知识图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#一些宏定义"><span class="toc-number">3.</span> <span class="toc-text">一些宏定义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JNIEXPORT"><span class="toc-number">3.1.</span> <span class="toc-text">JNIEXPORT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNIIMPORT"><span class="toc-number">3.2.</span> <span class="toc-text">JNIIMPORT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNICALL"><span class="toc-number">3.3.</span> <span class="toc-text">JNICALL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实例"><span class="toc-number">4.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用javah"><span class="toc-number">4.1.</span> <span class="toc-text">使用javah</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#java代码"><span class="toc-number">4.1.1.</span> <span class="toc-text">java代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-代码"><span class="toc-number">4.1.2.</span> <span class="toc-text">C++代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用RegisterNatives"><span class="toc-number">4.2.</span> <span class="toc-text">使用RegisterNatives</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#优点"><span class="toc-number">4.2.1.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java代码"><span class="toc-number">4.2.2.</span> <span class="toc-text">Java代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-代码-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">C++代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考链接"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="post-content"><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Java本地接口（Java Native Interface(JNI)）允许运行在Java虚拟机(Java Virtual Machine(JVM))上的代码调用本地程序和类库，或者被它们调用，这些程序和类库可以是其他语言编写的，比如：C、C++或汇编语言。<br>很多基本类库都依赖JNI来为开发者和用户提供服务，比如文件的输入/输出和音频功能。在基本类库中包含的对于性能和平台敏感的API可以允许所有的Java程序以安全和平台无关的方式来使用这些功能。</p>
<h1 id="知识图"><a href="#知识图" class="headerlink" title="知识图"></a>知识图</h1><p><img src="jni.png" alt=""></p>
<h1 id="一些宏定义"><a href="#一些宏定义" class="headerlink" title="一些宏定义"></a>一些宏定义</h1><p>windows宏定义的代码位置：<br><code>./jdk/src/windows/javavm/export/jni_md.h</code>）；<br>非windows宏定义代码位置（以MAC为例）：<br><code>./jdk/src/macosx/javavm/export/jni_md.h</code>）</p>
<h2 id="JNIEXPORT"><a href="#JNIEXPORT" class="headerlink" title="JNIEXPORT"></a>JNIEXPORT</h2><p>windows:<br><code>#define JNIEXPORT __declspec(dllexport)</code><br>非windows:<br><code>#define JNIEXPORT</code></p>
<h2 id="JNIIMPORT"><a href="#JNIIMPORT" class="headerlink" title="JNIIMPORT"></a>JNIIMPORT</h2><p>windows:<br><code>#define JNIIMPORT __declspec(dllimport)</code><br>非windows:<br><code>#define JNIIMPORT</code></p>
<h2 id="JNICALL"><a href="#JNICALL" class="headerlink" title="JNICALL"></a>JNICALL</h2><p>windows:<br><code>#define JNICALL __stdcall</code><br>非windows:<br><code>#define JNICALL</code></p>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><h2 id="使用javah"><a href="#使用javah" class="headerlink" title="使用javah"></a>使用javah</h2><h3 id="java代码"><a href="#java代码" class="headerlink" title="java代码"></a>java代码</h3><p>编写java代码，并生成C/C++头文件；</p>
<p>程序清单1: <code>HelloJni.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jackalope.study.jni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloJni</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"HelloJni"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">DisplayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HelloJni().DisplayHello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入src目录下，编译该JAVA类：</p>
<p><code>javac HelloJni.java</code></p>
<p>生成头文件：</p>
<p><code>javah org.jackalope.study.jni.HelloJni</code></p>
<p>得到头文件 org_jackalope_study_jni_HelloJni.h，此文件供C、C++程序来引用并实现其中的函数</p>
<p>程序清单2: <code>org_jackalope_study_jni_HelloJni.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">* DO NOT EDIT THIS FILE - it is machine generated */</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class org_jackalope_study_jni_HelloJni */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_org_jackalope_study_jni_HelloJni</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_org_jackalope_study_jni_HelloJni</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * Class:     org_jackalope_study_jni_HelloJni</span><br><span class="line"> * Method:    DisplayHello</span><br><span class="line"> * Signature: ()V</span><br><span class="line"> */</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_jackalope_study_jni_HelloJni_DisplayHello</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="C-代码"><a href="#C-代码" class="headerlink" title="C++代码"></a>C++代码</h3><p>编写C++代码，实现函数功能 ———— 打印”HelloJni”。</p>
<p>程序清单3：jni_helloworldImpl.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> org_jackalope_study_jni_HelloJni.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_org_jackalope_study_jni_HelloJni_DisplayHello</span><span class="params">(JNIEnv *env, jobject obj)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"From org_jackalope_study_jni_HelloJni.cpp :"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello world ! \n"</span>);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此C++文件实现了上述头文件中的函数，注意方法函数名要保持一致。<br>编译生成动态库libHelloJni.jnilib:<br><code>g++ -shared -I /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/include/ org_jackalope_study_jni_HelloJni.cpp -o libHelloJni.jnilib</code></p>
<p>注意：在mac下后缀名应当写为jnilib，这是由<br>./jdk/src/macosx/classes/java/lang/ClassLoaderHelper.java中的mapAlternativeName方法引起的，代码如下：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// For mac, this replaces the final .dylib suffix with .jnilib</span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">index</span> = name.toLowerCase().lastIndexOf(<span class="string">".dylib"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">index</span> &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> File(name.substring(<span class="number">0</span>, <span class="keyword">index</span>) + <span class="string">".jnilib"</span>);</span><br></pre></td></tr></table></figure>
<p>注意：<br>    mac下会提示找不到jni_md.h，创建一个软链接即可解决：<br>    <code>sudo ln -s darwin/jni_md.h jni_md.h</code></p>
<p>成功后，便会在当前目录下生成动态链接库libHelloJni.jnilib文件。<br>有了具体实现的动态库后，就可以运行JAVA调用JNI程序类的native方法了:<br><code>java -Djava.library.path=../c++/  org.jackalope.study.jni.HelloJni</code><br>输出：<br>From org_jackalope_study_jni_HelloJni.cpp :Hello world !</p>
<h2 id="使用RegisterNatives"><a href="#使用RegisterNatives" class="headerlink" title="使用RegisterNatives"></a>使用RegisterNatives</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li>C＋＋中函数命名自由，不必像javah自动生成的函数声明那样，拘泥特定的命名方式；</li>
<li>效率高。传统方式下，Java类call本地函数时，通常是依靠VM去动态寻找.so中的本地函数(因此它们才需要特定规则的命名格式)，而使用RegisterNatives将本地函数向VM进行登记，可以让其更有效率的找到函数；</li>
<li>运行时动态调整本地函数与Java函数值之间的映射关系，只需要多次call RegisterNatives()方法，并传入不同的映射表参数即可。</li>
</ol>
<p>为了使用RegisterNatives，我们需要了解JNI_OnLoad和JNI_OnUnload函数。JNI_OnLoad()函数在VM执行System.loadLibrary(xxx)函数时被调用，它有两个重要的作用：</p>
<ul>
<li>指定JNI版本：告诉VM该组件使用那一个JNI版本(若未提供JNI_OnLoad()函数，VM会默认该使用最老的JNI 1.1版)，如果要使用新版本的JNI，例如JNI 1.4版，则必须由JNI_OnLoad()函数返回常量JNI_VERSION_1_4(该常量定义在jni.h中) 来告知VM。</li>
<li>初始化设定，当VM执行到System.loadLibrary()函数时，会立即先呼叫JNI_OnLoad()方法，因此在该方法中进行各种资源的初始化操作最为恰当，RegisterNatives也在这里进行。</li>
</ul>
<p>JNI_OnUnload()当VM释放该组件时被调用，JNI_OnUnload()函数的作用与JNI_OnLoad()对应，因此在该方法中进行善后清理，资源释放的动作最为合适。</p>
<h3 id="Java代码"><a href="#Java代码" class="headerlink" title="Java代码"></a>Java代码</h3><p>Java代码和使用哪种方式实现JNI无关，如下所示：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">MyJavaClass</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">int</span> iValue;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Squa</span>(<span class="params"></span>)</span>&#123;iValue = iValue*iValue;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RegisterNativesTest</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">static</span>&#123;</span><br><span class="line">  System.load(<span class="string">"/home/zmh/workspace/RegisterNativesTest/lib/libCallClass.so"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>)</span><br><span class="line"> </span>&#123;</span><br><span class="line">  RegisterNativesTest app = <span class="keyword">new</span> RegisterNativesTest();</span><br><span class="line">  MyJavaClass obj = <span class="keyword">new</span> MyJavaClass();</span><br><span class="line">  obj.iValue = <span class="number">10</span>;</span><br><span class="line">  System.<span class="keyword">out</span>.println(<span class="string">"Before callCustomClass: "</span> + obj.iValue);</span><br><span class="line">  app.callCustomClass(obj);</span><br><span class="line">  System.<span class="keyword">out</span>.println(<span class="string">"After callCustomClass: "</span> + obj.iValue);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> native <span class="keyword">void</span> <span class="title">callCustomClass</span>(<span class="params">MyJavaClass obj</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="C-代码-1"><a href="#C-代码-1" class="headerlink" title="C++代码"></a>C++代码</h3><p>C＋＋的代码可以分为两部分：实现callCustomClass方法和注册callCustomClass。<br>实现callCustomClass方法的代码如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void callCustomClass(<span class="keyword">JNIEnv* </span>env, <span class="keyword">jobject, </span><span class="keyword">jobject </span>obj)</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">jclass </span>cls = env-&gt;GetObjectClass(obj)<span class="comment">;</span></span><br><span class="line"> <span class="keyword">jfieldID </span>fid = env-&gt;GetFieldID(cls, <span class="string">"iValue"</span>, <span class="string">"I"</span>)<span class="comment">;</span></span><br><span class="line"> <span class="keyword">jmethodID </span>mid = env-&gt;GetMethodID(cls, <span class="string">"Squa"</span>, <span class="string">"()V"</span>)<span class="comment">;</span></span><br><span class="line"> int value = env-&gt;GetIntField(obj, fid)<span class="comment">;</span></span><br><span class="line"> printf(<span class="string">"Native: %d\n"</span>, value)<span class="comment">;</span></span><br><span class="line"> env-&gt;SetIntField(obj, fid, <span class="number">5</span>)<span class="comment">;</span></span><br><span class="line"> env-&gt;CallVoidMethod(obj, mid)<span class="comment">;</span></span><br><span class="line"> value = env-&gt;GetIntField(obj, fid)<span class="comment">;</span></span><br><span class="line"> printf(<span class="string">"Native:%d\n"</span>, value)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C＋＋函数内忽略this指针，他所接收的jobject是“Java程序代码传递过来的Java object reference“在原生端的形式，在C＋＋中对jobject的改变在java中也是有效的。如果想要访问Java数据成员和函数，得先使用GetFieldID或GetMethodID分别获取数据成员和函数的识别码，这两个函数的参数依次为1）class object；2）包含元素名称的字符串；3）表示类型的字符串。<br>注册callCustomClass在JNI_OnLoad中进行，代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod s_methods[] = &#123;</span><br><span class="line">&#123;<span class="string">"callCustomClass"</span>, <span class="string">"(LMyJavaClass;)V"</span>, (<span class="keyword">void</span>*)callCustomClass&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> JNI_OnLoad(JavaVM* vm, <span class="keyword">void</span>* reserved)</span><br><span class="line">&#123;</span><br><span class="line"> JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">   <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> jclass cls = env-&gt;FindClass(<span class="string">"LRegisterNativesTest;"</span>);</span><br><span class="line">   <span class="keyword">if</span> (cls == <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> len = <span class="keyword">sizeof</span>(s_methods) / <span class="keyword">sizeof</span>(s_methods[<span class="number">0</span>]);</span><br><span class="line">   <span class="keyword">if</span> (env-&gt;RegisterNatives(cls, s_methods, len) &lt; <span class="number">0</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> JNI_VERSION_1_4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在C＋＋和Java中创建关联的是JNINativeMethod，它在jni.h中定义：</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * used <span class="keyword">in</span> <span class="type">RegisterNatives</span> <span class="keyword">to</span> describe native <span class="keyword">method</span> name, signature,</span><br><span class="line"> * <span class="keyword">and</span> <span class="keyword">function</span> pointer.</span><br><span class="line"> */</span><br><span class="line">typedef <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="built_in">char</span> *name;</span><br><span class="line">    <span class="built_in">char</span> *signature;</span><br><span class="line">    void *fnPtr;</span><br><span class="line">&#125; <span class="type">JNINativeMethod</span>;</span><br></pre></td></tr></table></figure>
<p>name是java中定义的native函数的名字，fnPtr是函数指针，也就是C＋＋中java native函数的实现。signature是java native函数的签名，可以认为是参数和返回值。比如(LMyJavaClass;)V，表示函数的参数是LMyJavaClass，返回值是void。对于基本类型，对应关系如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">字符     Java类型     C/C++类型</span><br><span class="line">V           <span class="keyword">void</span>         <span class="keyword">void</span></span><br><span class="line">Z         jboolean      <span class="keyword">boolean</span></span><br><span class="line">I            jint           <span class="keyword">int</span></span><br><span class="line">J           jlong         <span class="keyword">long</span></span><br><span class="line">D         jdouble       <span class="keyword">double</span></span><br><span class="line">F          jfloat         <span class="keyword">float</span></span><br><span class="line">B          jbyte         <span class="keyword">byte</span></span><br><span class="line">C          jchar          <span class="keyword">char</span></span><br><span class="line">S          jshort        <span class="keyword">short</span></span><br></pre></td></tr></table></figure>
<p>数组则以”[“开始，用两个字符表示，比如int数组表示为［I，以此类推。<br>如果参数是Java类，则以”L”开头，以”;”结尾，中间是用”/“隔开包及类名，例如Ljava/lang/String;，而其对应的C＋＋函数的参数为jobject，一个例外是String类，它对应C＋＋类型jstring。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.cnblogs.com/mandroid/archive/2011/06/15/2081093.html" target="_blank" rel="external">JAVA基础之理解JNI原理</a><br><a href="http://blog.csdn.net/qiuxiaolong007/article/details/7860610" target="_blank" rel="external">JNI：使用RegisterNatives方法传递和使用Java自定义类</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://jackalope.cn/2016/04/13/java-core-jni/" data-id="ciunpzx3r000n4cekdwwpnmvs" class="article-share-link">分享到</a><div class="tags"><a href="/tags/java/">java</a><a href="/tags/jni/">jni</a></div><div class="post-nav"><a href="/2016/04/14/java-core-object/" class="pre">Object类详解</a><a href="/2016/04/06/hive-language-manual/" class="next">Hive语法手册</a></div><div id="disqus_thread"><script>var disqus_shortname = 'hedgehog-zowie';
var disqus_identifier = '2016/04/13/java-core-jni/';
var disqus_title = 'JNI（Java Native Interface）原理与使用';
var disqus_url = 'http://jackalope.cn/2016/04/13/java-core-jni/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//hedgehog-zowie.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://jackalope.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Flume/">Flume</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HBase/">HBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java总结/">Java总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hive/">hive</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java基础/">java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/Flume/" style="font-size: 15px;">Flume</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/HBase/" style="font-size: 15px;">HBase</a> <a href="/tags/hive/" style="font-size: 15px;">hive</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/集合/" style="font-size: 15px;">集合</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/jni/" style="font-size: 15px;">jni</a> <a href="/tags/nio/" style="font-size: 15px;">nio</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/spark/" style="font-size: 15px;">spark</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/flume-trouble-shooting/">flume-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/shell-trouble-shooting/">shell-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/hive-trouble-shooting/">hive-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/hbase-trouble-shooting/">hbase-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/23/spark-tips/">spark-tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/js-trouble-shooting/">js-trouble-shooting</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/09/mysql-tips/">mysql-tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/15/hive-params/">hive-params</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/java-core-conception/">Java总结 - 基本概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/19/java-core-collections/">集合总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//hedgehog-zowie.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">破而后立.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>